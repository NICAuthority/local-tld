#!/bin/sh -ex

PWD=`pwd`

# thanks http://stackoverflow.com/questions/630372/determine-the-path-of-the-executing-bash-script
MY_PATH="`dirname \"$0\"`"
MY_PATH="`( cd \"$MY_PATH\" && pwd )`"
ETC=$MY_PATH/../etc

# see if NODE_PATH is set.
# if not, try to guess a bit
if [ -z "$NODE_PATH" ]; then
  TEST_PATH=/usr/local/share/npm/lib/node_modules
  if [ -d "$TEST_PATH" ]; then
    NODE_PATH="$TEST_PATH"
  fi

  TEST_PATH=/usr/local/lib/node_modules
  if [ -d "$TEST_PATH" ]; then
    NODE_PATH="$TEST_PATH"
  fi

  if [ -z "$NODE_PATH"]; then
    echo "CANT DETERMINE NODE_PATH."
    echo "PLEASE SET NODE_PATH MANUALLY AND RUN THE INSTALLATION AGAIN"
  else
    echo "Guessed NODE_PATH '$NODE_PATH'"
    echo "Please set it in your shell environment."
  fi
fi


# set /ect/*.tpl vars
sed -e s,{{NODE_PATH}},$NODE_PATH, \
  etc/ie.hood.local-tld-service.plist.tpl \
  > etc/ie.hood.local-tld-service.plist


# cp etc/* to targets

sudo mkdir -p /etc/resolver
sudo cp $ETC/resolver.dev /etc/resolver/dev

sudo cp $ETC/ie.hood.local-tld-firewall.plist /Library/LaunchDaemons/

cp $ETC/ie.hood.local-tld-service.plist $HOME/Library/LaunchAgents/

# launchin

sudo launchctl load -Fw /Library/LaunchDaemons/ie.hood.local-tld-firewall.plist

launchctl unload $HOME/Library/LaunchAgents/ie.hood.local-tld-service.plist
launchctl load -Fw $HOME/Library/LaunchAgents/ie.hood.local-tld-service.plist

echo "Setup done."
